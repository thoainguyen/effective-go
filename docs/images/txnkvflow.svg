<?xml version="1.0" encoding="UTF-8" standalone="no"?><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" contentScriptType="application/ecmascript" contentStyleType="text/css" height="894px" preserveAspectRatio="none" style="width:493px;height:894px;" version="1.1" viewBox="0 0 493 894" width="493px" zoomAndPan="magnify"><defs><filter height="300%" id="f1tkg7n4uln3o" width="300%" x="-1" y="-1"><feGaussianBlur result="blurOut" stdDeviation="2.0"/><feColorMatrix in="blurOut" result="blurOut2" type="matrix" values="0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 .4 0"/><feOffset dx="4.0" dy="4.0" in="blurOut2" result="blurOut3"/><feBlend in="SourceGraphic" in2="blurOut3" mode="normal"/></filter></defs><g><rect fill="#FFFFFF" filter="url(#f1tkg7n4uln3o)" height="353.2656" style="stroke: #000000; stroke-width: 2.0;" width="469.5" x="13" y="113.5625"/><rect fill="#FFFFFF" filter="url(#f1tkg7n4uln3o)" height="322.1328" style="stroke: #000000; stroke-width: 2.0;" width="449.5" x="23" y="137.6953"/><rect fill="#FFFFFF" filter="url(#f1tkg7n4uln3o)" height="75.3984" style="stroke: #000000; stroke-width: 2.0;" width="331.5" x="131" y="233.0938"/><rect fill="#FFFFFF" height="115.2031" style="stroke: none; stroke-width: 1.0;" width="449.5" x="23" y="344.625"/><rect fill="#FFFFFF" filter="url(#f1tkg7n4uln3o)" height="106.5313" style="stroke: #000000; stroke-width: 2.0;" width="351.5" x="121" y="552.0938"/><rect fill="#FFFFFF" filter="url(#f1tkg7n4uln3o)" height="75.3984" style="stroke: #000000; stroke-width: 2.0;" width="331.5" x="131" y="576.2266"/><rect fill="#FFFFFF" filter="url(#f1tkg7n4uln3o)" height="106.5313" style="stroke: #000000; stroke-width: 2.0;" width="351.5" x="121" y="701.7578"/><rect fill="#FFFFFF" filter="url(#f1tkg7n4uln3o)" height="75.3984" style="stroke: #000000; stroke-width: 2.0;" width="331.5" x="131" y="725.8906"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="60" x2="60" y1="38.2969" y2="854.4219"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="178" x2="178" y1="38.2969" y2="854.4219"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="361.5" x2="361.5" y1="38.2969" y2="854.4219"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="425.5" x2="425.5" y1="38.2969" y2="854.4219"/><rect fill="#FEFECE" filter="url(#f1tkg7n4uln3o)" height="30.2969" style="stroke: #A80036; stroke-width: 1.5;" width="51" x="33" y="3"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="37" x="40" y="22.9951">client</text><rect fill="#FEFECE" filter="url(#f1tkg7n4uln3o)" height="30.2969" style="stroke: #A80036; stroke-width: 1.5;" width="51" x="33" y="853.4219"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="37" x="40" y="873.417">client</text><rect fill="#FEFECE" filter="url(#f1tkg7n4uln3o)" height="30.2969" style="stroke: #A80036; stroke-width: 1.5;" width="71" x="141" y="3"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="57" x="148" y="22.9951">mtikv_cli</text><rect fill="#FEFECE" filter="url(#f1tkg7n4uln3o)" height="30.2969" style="stroke: #A80036; stroke-width: 1.5;" width="71" x="141" y="853.4219"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="57" x="148" y="873.417">mtikv_cli</text><rect fill="#FEFECE" filter="url(#f1tkg7n4uln3o)" height="30.2969" style="stroke: #A80036; stroke-width: 1.5;" width="32" x="343.5" y="3"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="18" x="350.5" y="22.9951">pd</text><rect fill="#FEFECE" filter="url(#f1tkg7n4uln3o)" height="30.2969" style="stroke: #A80036; stroke-width: 1.5;" width="32" x="343.5" y="853.4219"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="18" x="350.5" y="873.417">pd</text><rect fill="#FEFECE" filter="url(#f1tkg7n4uln3o)" height="30.2969" style="stroke: #A80036; stroke-width: 1.5;" width="50" x="398.5" y="3"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="36" x="405.5" y="22.9951">mtikv</text><rect fill="#FEFECE" filter="url(#f1tkg7n4uln3o)" height="30.2969" style="stroke: #A80036; stroke-width: 1.5;" width="50" x="398.5" y="853.4219"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="36" x="405.5" y="873.417">mtikv</text><polygon fill="#A80036" points="166.5,65.4297,176.5,69.4297,166.5,73.4297,170.5,69.4297" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="60.5" x2="172.5" y1="69.4297" y2="69.4297"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="67" x="67.5" y="64.3638">beginTxn()</text><polygon fill="#A80036" points="349.5,94.5625,359.5,98.5625,349.5,102.5625,353.5,98.5625" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="178.5" x2="355.5" y1="98.5625" y2="98.5625"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="121" x="185.5" y="93.4966">start_ts = getTso()</text><path d="M13,113.5625 L90,113.5625 L90,120.5625 L80,130.5625 L13,130.5625 L13,113.5625 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="353.2656" style="stroke: #000000; stroke-width: 2.0;" width="469.5" x="13" y="113.5625"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="32" x="28" y="126.6294">loop</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="91" x="105" y="125.7729">[do command]</text><path d="M23,137.6953 L87,137.6953 L87,144.6953 L77,154.6953 L23,154.6953 L23,137.6953 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="322.1328" style="stroke: #000000; stroke-width: 2.0;" width="449.5" x="23" y="137.6953"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="19" x="38" y="150.7622">alt</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="51" x="102" y="149.9058">[do get]</text><polygon fill="#A80036" points="166.5,171.9609,176.5,175.9609,166.5,179.9609,170.5,175.9609" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="60.5" x2="172.5" y1="175.9609" y2="175.9609"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="53" x="67.5" y="170.895">get(key)</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="178.5" x2="220.5" y1="205.0938" y2="205.0938"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="220.5" x2="220.5" y1="205.0938" y2="218.0938"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="179.5" x2="220.5" y1="218.0938" y2="218.0938"/><polygon fill="#A80036" points="189.5,214.0938,179.5,218.0938,189.5,222.0938,185.5,218.0938" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="152" x="185.5" y="200.0278">value = readBuffer(key)</text><path d="M131,233.0938 L201,233.0938 L201,240.0938 L191,250.0938 L131,250.0938 L131,233.0938 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="75.3984" style="stroke: #000000; stroke-width: 2.0;" width="331.5" x="131" y="233.0938"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="25" x="146" y="246.1606">opt</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="100" x="216" y="245.3042">[if value == nil]</text><polygon fill="#A80036" points="413.5,267.3594,423.5,271.3594,413.5,275.3594,417.5,271.3594" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="178.5" x2="419.5" y1="271.3594" y2="271.3594"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="110" x="185.5" y="266.2935">get(key, start_ts)</text><polygon fill="#A80036" points="189.5,296.4922,179.5,300.4922,189.5,304.4922,185.5,300.4922" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="183.5" x2="424.5" y1="300.4922" y2="300.4922"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="34" x="195.5" y="295.4263">value</text><polygon fill="#A80036" points="71.5,332.625,61.5,336.625,71.5,340.625,67.5,336.625" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="65.5" x2="177.5" y1="336.625" y2="336.625"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="34" x="77.5" y="331.5591">value</text><line style="stroke: #000000; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="23" x2="472.5" y1="345.625" y2="345.625"/><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="99" x="28" y="355.8354">[do set, delete]</text><polygon fill="#A80036" points="166.5,376.5625,176.5,380.5625,166.5,384.5625,170.5,380.5625" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="60.5" x2="172.5" y1="380.5625" y2="380.5625"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="94" x="67.5" y="375.4966">set(key, value)</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="178.5" x2="220.5" y1="409.6953" y2="409.6953"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="220.5" x2="220.5" y1="409.6953" y2="422.6953"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="179.5" x2="220.5" y1="422.6953" y2="422.6953"/><polygon fill="#A80036" points="189.5,418.6953,179.5,422.6953,189.5,426.6953,185.5,422.6953" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="138" x="185.5" y="404.6294">writeBuffer(key,value)</text><polygon fill="#A80036" points="71.5,447.8281,61.5,451.8281,71.5,455.8281,67.5,451.8281" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="65.5" x2="177.5" y1="451.8281" y2="451.8281"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="15" x="77.5" y="446.7622">ok</text><polygon fill="#A80036" points="166.5,490.9609,176.5,494.9609,166.5,498.9609,170.5,494.9609" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="60.5" x2="172.5" y1="494.9609" y2="494.9609"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="81" x="67.5" y="489.895">commitTxn()</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="178.5" x2="220.5" y1="524.0938" y2="524.0938"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="220.5" x2="220.5" y1="524.0938" y2="537.0938"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="179.5" x2="220.5" y1="537.0938" y2="537.0938"/><polygon fill="#A80036" points="189.5,533.0938,179.5,537.0938,189.5,541.0938,185.5,537.0938" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="169" x="185.5" y="519.0278">group mutations by region</text><path d="M121,552.0938 L191,552.0938 L191,559.0938 L181,569.0938 L121,569.0938 L121,552.0938 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="106.5313" style="stroke: #000000; stroke-width: 2.0;" width="351.5" x="121" y="552.0938"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="25" x="136" y="565.1606">opt</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="84" x="206" y="564.3042">[do prewrite]</text><path d="M131,576.2266 L208,576.2266 L208,583.2266 L198,593.2266 L131,593.2266 L131,576.2266 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="75.3984" style="stroke: #000000; stroke-width: 2.0;" width="331.5" x="131" y="576.2266"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="32" x="146" y="589.2935">loop</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="108" x="223" y="588.437">[for each region]</text><polygon fill="#A80036" points="413.5,610.4922,423.5,614.4922,413.5,618.4922,417.5,614.4922" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="178.5" x2="419.5" y1="614.4922" y2="614.4922"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="183" x="185.5" y="609.4263">Prewrite(mutations, start_ts)</text><polygon fill="#A80036" points="189.5,639.625,179.5,643.625,189.5,647.625,185.5,643.625" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="183.5" x2="424.5" y1="643.625" y2="643.625"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="86" x="195.5" y="638.5591">prewrite error</text><polygon fill="#A80036" points="349.5,682.7578,359.5,686.7578,349.5,690.7578,353.5,686.7578" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="178.5" x2="355.5" y1="686.7578" y2="686.7578"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="140" x="185.5" y="681.6919">commit_ts = getTso()</text><path d="M121,701.7578 L191,701.7578 L191,708.7578 L181,718.7578 L121,718.7578 L121,701.7578 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="106.5313" style="stroke: #000000; stroke-width: 2.0;" width="351.5" x="121" y="701.7578"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="25" x="136" y="714.8247">opt</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="76" x="206" y="713.9683">[do commit]</text><path d="M131,725.8906 L208,725.8906 L208,732.8906 L198,742.8906 L131,742.8906 L131,725.8906 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="75.3984" style="stroke: #000000; stroke-width: 2.0;" width="331.5" x="131" y="725.8906"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="32" x="146" y="738.9575">loop</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="108" x="223" y="738.1011">[for each region]</text><polygon fill="#A80036" points="413.5,760.1563,423.5,764.1563,413.5,768.1563,417.5,764.1563" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="178.5" x2="419.5" y1="764.1563" y2="764.1563"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="223" x="185.5" y="759.0903">Commit(keys, start_ts, commit_ts)</text><polygon fill="#A80036" points="189.5,789.2891,179.5,793.2891,189.5,797.2891,185.5,793.2891" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="183.5" x2="424.5" y1="793.2891" y2="793.2891"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="84" x="195.5" y="788.2231">commit error</text><polygon fill="#A80036" points="71.5,832.4219,61.5,836.4219,71.5,840.4219,67.5,836.4219" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="65.5" x2="177.5" y1="836.4219" y2="836.4219"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="89" x="77.5" y="831.356">success/failed</text><!--
@startuml
client -> mtikv_cli : beginTxn()
mtikv_cli -> pd : start_ts = getTso()
loop do command
    alt do get
        client -> mtikv_cli: get(key)
        mtikv_cli -> mtikv_cli: value = readBuffer(key)
        opt if value == nil
            mtikv_cli -> mtikv: get(key, start_ts)
            mtikv - -> mtikv_cli:  value
        end
        mtikv_cli - -> client: value
    else do set, delete
        client->mtikv_cli: set(key, value)
        mtikv_cli -> mtikv_cli: writeBuffer(key,value)
        mtikv_cli - -> client: ok
    end
end
client -> mtikv_cli: commitTxn()
mtikv_cli -> mtikv_cli: group mutations by region
opt do prewrite
    loop for each region
        mtikv_cli -> mtikv: Prewrite(mutations, start_ts)
        mtikv - -> mtikv_cli: prewrite error
    end
end
mtikv_cli -> pd: commit_ts = getTso()
opt do commit
    loop for each region
        mtikv_cli -> mtikv: Commit(keys, start_ts, commit_ts)
        mtikv - -> mtikv_cli: commit error
    end
end

mtikv_cli - -> client:  success/failed
@enduml

PlantUML version 1.2019.04(Fri Mar 29 15:44:36 UTC 2019)
(GPL source distribution)
Java Runtime: OpenJDK Runtime Environment
JVM: OpenJDK 64-Bit Server VM
Java Version: 1.8.0_201-heroku-b09
Operating System: Linux
OS Version: 4.4.0-1048-aws
Default Encoding: UTF-8
Language: en
Country: US
--></g></svg>